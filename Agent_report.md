這是一份關於如何利用 LLM（如 Gemini）結合 React 前端架構，構建專業「飛行事件鑑定報告系統」的實作藍圖。

---

# 🚀 LLM 飛行事件鑑定報告系統：實作藍圖

這是一個非常好的應用場景。要讓 LLM 撰寫專業的「事件鑑定報告」，單純將 CSV 丟進去是不夠的，原因如下：
1.  **Token 效率與數學能力**：LLM 對長篇純數字序列（Raw Data）理解有限，且易產生幻覺。
2.  **專業領域知識**：LLM 懂物理，但不一定懂特定飛控（如 ArduPilot, Betaflight）的錯誤碼或硬體極限。
3.  **報告結構**：鑑定報告需要嚴謹邏輯（事實 -> 分析 -> 結論），而非閒聊。

基於現有的 **React + Gemini** 架構，不需要大改後端，可透過 **「Agentic Workflow (代理人工作流)」** 加上 **「RAG (檢索增強生成)」** 的概念來實現。

---

## 🛠️ 第一階段：數據預處理與特徵工程 (Feature Engineering)
**目標：讓 LLM 讀懂「特徵」，而不是讀懂 Raw Data。**
目前擷取前 1000 行的做法容易錯過後段墜機點，建議修改方向如下：

### 1. 自動分段 (Segmentation)
在前端 (TypeScript) 撰寫邏輯，自動標記飛行階段：
*   `Disarmed` (待機)
*   `Takeoff` (起飛)
*   `Cruise` (巡航)
*   `Incident` (異常發生)
*   `Crash/End` (墜毀/結束)

**找出「關鍵時刻」**：
*   `is_armed` 變為 0 的瞬間。
*   `error` 欄位非 0 的瞬間。
*   `vibr_z` (震動) 超過閾值的瞬間。

### 2. 統計特徵提取
不要餵給 AI 每一秒的電壓，而是提供統計摘要：
*   平均電壓、最低電壓（及發生時間）。
*   最大震動值。
*   最大姿態傾角。

> **Prompt 範例：**
> 「飛行總長 15 分鐘。在 T+300s 時，電壓從 24V 驟降至 18V。在 T+305s 時，Z 軸震動達到 50m/s²。」

---

## 📚 第二階段：RAG (檢索增強生成) 導入
**目標：讓 LLM 擁有查閱「維修手冊」與「過往案例」的能力。**
RAG 在此的用途是檢索「知識」，而非 CSV 數據。

### 1. 知識庫建立 (Vector Store / JSON)
*   `error_codes.json`：定義每個錯誤碼的意義與可能原因。
*   `flight_manual.md`：定義該機型的抗風等級、最大電流限制等規格。
*   *(進階)* `past_incidents.csv`：過往類似案例分析。

### 2. 注入 Context
在送出請求前，先根據 Log 中的錯誤碼（如 `Error: 24`），檢索知識庫中關於 "Error 24" 的解釋，將文字加入 System Instruction。
*   **效果**：AI 不會瞎掰錯誤碼，而是根據技術文件解釋。

---

## 🤖 第三階段：Agentic Workflow (多步驟代理人)
**目標：模仿人類調查員思考步驟，分次呼叫 LLM，將單一 Chat 拆解為「工作鏈」。**

### Step 1: Agent 1 - 導航員 (The Segmenter)
*   **任務**：分析 Log 元數據與關鍵事件點。
*   **Input**：統計數據、錯誤碼列表。
*   **Output**：定義「事故發生時間窗口 (Time Window)」。
    *   *例：「事故發生在 12:45:30，請專注分析前後 30 秒的數據。」*

### Step 2: Agent 2 - 系統工程師 (The Data Analyst) *[可平行執行]*
*   **任務**：針對時間窗口內的特定子系統進行分析。
    *   **子任務 A (電力)**：只看電壓、電流。判斷斷電或過載。
    *   **子任務 B (姿態/控制)**：只看 Roll/Pitch/Yaw 與馬達輸出。判斷機械故障或氣動失速。
*   **Input**：該時間窗口內的 CSV 片段 (範圍縮小，數據可更詳細) + 相關圖表圖片。

### Step 3: Agent 3 - 鑑定官 (The Report Writer)
*   **任務**：彙整 Agent 1 & 2 的發現，撰寫最終報告。
*   **Input**：Agent 1 的時序表 + Agent 2 的分析結論 + RAG 檢索到的法規/手冊標準。
*   **Output**：符合標準格式的 Markdown 報告。

---

## 👁️ 第四階段：多模態能力 (Multimodal / Vision)
**目標：讓 Gemini 用「看」的，就像人類看圖表一樣。**
Gemini 2.5 Flash 具備極強視覺能力，直接看圖比轉述波形更有效。

### 前端實作
使用 `html2canvas` 或 `recharts` 的匯出功能，將「撞擊前後 10 秒」的關鍵圖表（如三軸震動圖、電壓電流圖）轉為 **Base64** 圖片。

> **Prompt 範例：**
> 「這是一張事故發生前後的震動圖表。請分析 X 軸震動是否有異常高頻雜訊？這是否符合螺旋槳鬆脫的特徵？」

---

## 📅 實作路徑建議 (Implementation Steps)
不需要一次到位，可在現有 App 中迭代：

1.  **v1 (現有基礎增強)**：
    *   在 `logProcessor.ts` 新增 `generateFlightSummary()`。
    *   計算關鍵統計值 (Min/Max/Avg) 和錯誤碼列表，放入 System Instruction 取代 Raw Data。
2.  **v2 (視覺輔助)**：
    *   在 Chat 介面新增功能，自動截取當前圖表並作為 Image Part 傳送給 Gemini。
    *   讓使用者問：「看這張圖，這裡的波形正常嗎？」
3.  **v3 (結構化報告生成器)**：
    *   新增「生成報告」按鈕。
    *   背景執行 Chain of Thought (3次 API Calls)：找出異常 -> 解釋原因 -> 輸出 Markdown。

---

## 💡 關於微調 (Fine-tuning)
**暫時不需要。**
除非擁有成千上萬份「已標註」的事故報告（CSV + 完美人類分析），否則微調效果不如 **Long Context Window (Gemini 2.5)** 加上 **良好的 Prompt Engineering**。目前的策略應集中在如何「餵給 AI 對的資料片段」。

---

## ✅ 總結
*   **不用改變 React 架構。**
*   **核心觀念**：不要把整個 CSV 丟進去期待奇蹟。
*   **執行策略**：透過程式碼先篩選關鍵時間與特徵，配合圖表截圖，分步驟引導 Gemini 扮演分析師的角色。