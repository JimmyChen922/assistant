<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiRC- å°ç£æ¸¬ç«™æ°£è±¡è³‡æ–™æŸ¥è©¢</title>
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { padding: 20px; }
        .table-container { margin-top: 0; }
        table { 
            width: 100%; 
            table-layout: fixed;
        }
        th, td { 
            text-align: center; 
            padding: 12px 8px;
            font-size: 14px;
        }
        
        /* åœ°åœ–æ¨£å¼ */
        #map { 
            height: 500px; 
            width: 100%; 
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .map-container {
            margin-top: 0;
            margin-bottom: 0;
        }
        
        /* å·¦å³å¸ƒå±€æ¨£å¼ */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }
        
        .left-panel {
            flex: 1;
            min-width: 0;
            max-width: 50%;
            overflow-x: auto;
        }
        
        .right-panel {
            flex: 1;
            min-width: 0;
            max-width: 50%;
        }
        
        /* è¡¨é ­æ¨£å¼ */
        .table-dark,
        thead.table-dark,
        .table thead.table-dark,
        .table thead.table-dark tr {
            background-color: #0047AB !important;
        }
        
        .table-dark th,
        thead.table-dark th,
        .table thead.table-dark th {
            color: #000000 !important;
            font-weight: bold;
            background-color: #0047AB !important;
        }
        
        /* å¼·åˆ¶å¸ƒå±€æ§åˆ¶ */
        .container {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .main-content {
            display: flex !important;
            flex-wrap: nowrap !important;
            width: 100% !important;
        }
        
        .left-panel {
            flex: 0 0 60% !important;
            max-width: 60% !important;
            overflow-x: auto;
        }
        
        .right-panel {
            flex: 0 0 40% !important;
            max-width: 40% !important;
        }
        
        /* é¢¨é€Ÿè­¦å‘Šæ¨£å¼ */
        .wind-warning {
            color: #dc3545 !important;
            font-weight: bold;
            background-color: #fff5f5 !important;
        }
        
        .wind-alert {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        /* éŸ¿æ‡‰å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            #map { height: 300px; }
            .left-panel, .right-panel {
                max-width: 100%;
            }
        }
        
        /* ç‰ˆæ¬Šè³‡è¨Šæ¨£å¼ */
        #credit {
            position: fixed;
            right: 10px;
            bottom: 10px;
            font-size: 12px;
            color: #aaa;
            cursor: pointer;
            user-select: none;
        }
        #credit:hover {
            color: #555;
        }
        
        /* å¤©æ°£åœ–æ¨™æ¨£å¼ */
        .weather-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
        }
        
        .temp-hot { background-color: #ff4444; }
        .temp-warm { background-color: #ff8800; }
        .temp-mild { background-color: #44aa44; }
        .temp-cool { background-color: #4488ff; }
        .temp-cold { background-color: #4444ff; }
        
        /* éŸ¿æ‡‰å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            #map { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center">CiRC- å°ç£æ¸¬ç«™æ°£è±¡è³‡æ–™æŸ¥è©¢</h2>
        <form id="weatherForm" class="mb-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="dateTime" class="form-label">æ—¥æœŸèˆ‡æ™‚é–“</label>
                    <input type="datetime-local" class="form-control" id="dateTime" required>
                </div>
                <div class="col-md-3">
                    <label for="location" class="form-label">åœ°é»</label>
                    <input type="text" class="form-control" id="location" value="ééƒ¨" placeholder="è«‹è¼¸å…¥æ¸¬ç«™åç¨±">
                </div>
                <div class="col-md-3">
                    <label for="apiKey" class="form-label">API æˆæ¬Šç¢¼</label>
                    <input type="password" class="form-control" id="apiKey" value="CWA-BC818A75-95F0-4917-AE45-2459483BDCD9" placeholder="è«‹è¼¸å…¥CWA APIæˆæ¬Šç¢¼" required>
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="submit" class="btn btn-primary w-100" id="queryBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner"></span>
                        <span id="btnText">æŸ¥è©¢</span>
                    </button>
                </div>
                <div class="col-md-1 align-self-end">
                    <button type="button" class="btn btn-info w-100" id="debugBtn" onclick="debugAPI()">
                        é™¤éŒ¯
                    </button>
                </div>
                <div class="col-md-1 align-self-end">
                    <button type="button" class="btn btn-success w-100" id="refreshMapBtn" onclick="loadAllStationsWeather()">
                        æ›´æ–°åœ°åœ–
                    </button>
                </div>
            </div>
        </form>

        <!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
        <div id="errorAlert" class="alert alert-danger d-none" role="alert">
            <strong>éŒ¯èª¤ï¼š</strong><span id="errorMessage"></span>
        </div>

        <!-- æˆåŠŸè¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
        <div id="successAlert" class="alert alert-success d-none" role="alert">
            <strong>æˆåŠŸï¼š</strong>è³‡æ–™è¼‰å…¥å®Œæˆï¼
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ - å·¦å³å¸ƒå±€ -->
        <div class="main-content">
            <!-- å·¦å´é¢æ¿ - è³‡æ–™è¡¨æ ¼ -->
            <div class="left-panel">
                <h4 class="text-center mb-3">æ°£è±¡è³‡æ–™è©³ç´°è³‡è¨Š</h4>
        <div class="table-container">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>è§€æ¸¬æ™‚é–“</th>
                        <th>æº«åº¦ (Â°C)</th>
                        <th>å¤©æ°£</th>
                                <th>é¢¨å‘ (åº¦)</th>
                                <th>é¢¨åŠ› (m/s)</th>
                                <th>é™£é¢¨ (m/s)</th>
                                <th>èƒ½è¦‹åº¦</th>
                        <th>ç›¸å°æº¼åº¦ (%)</th>
                        <th>æµ·å¹³é¢æ°£å£“ (ç™¾å¸•)</th>
                        <th>ç•¶æ—¥ç´¯ç©é›¨é‡ (æ¯«ç±³)</th>
                        <th>æ—¥ç…§æ™‚æ•¸ (å°æ™‚)</th>
                    </tr>
                </thead>
                <tbody id="weatherTableBody">
                    <!-- è³‡æ–™å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                </tbody>
            </table>
                </div>
                
                <!-- é¢¨é€Ÿè­¦å‘Šè¨Šæ¯å€åŸŸ -->
                <div id="windAlert" class="wind-alert d-none">
                    <i class="fas fa-exclamation-triangle"></i>
                    é¢¨é€Ÿéå¤§ï¼Œä¸å»ºè­°é€²è¡Œç„¡äººæ©Ÿæ“ä½œ
                </div>
            </div>

            <!-- å³å´é¢æ¿ - å°ç£åœ°åœ– -->
            <div class="right-panel">
                <h4 class="text-center mb-3">å°ç£åœ°åœ–</h4>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="text-center mt-2">
                        <small class="text-muted">é»æ“Šåœ°åœ–ä¸Šçš„æ¸¬ç«™åœ–æ¨™æŸ¥çœ‹è©³ç´°å¤©æ°£è³‡è¨Š</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åœ°åœ–ç›¸é—œè®Šæ•¸
        let map;
        let weatherMarkers = [];
        
        // å°ç£ä¸»è¦æ¸¬ç«™åº§æ¨™è³‡æ–™
        const taiwanStations = [
            { name: "å°åŒ—", lat: 25.0330, lng: 121.5654, code: "å°åŒ—" },
            { name: "å°ä¸­", lat: 24.1477, lng: 120.6736, code: "å°ä¸­" },
            { name: "é«˜é›„", lat: 22.6273, lng: 120.3014, code: "é«˜é›„" },
            { name: "åŸºéš†", lat: 25.1276, lng: 121.7395, code: "åŸºéš†" },
            { name: "æ–°ç«¹", lat: 24.8066, lng: 120.9686, code: "æ–°ç«¹" },
            { name: "å˜‰ç¾©", lat: 23.4871, lng: 120.4488, code: "å˜‰ç¾©" },
            { name: "å°å—", lat: 23.0000, lng: 120.2000, code: "å°å—" },
            { name: "èŠ±è“®", lat: 23.9739, lng: 121.6014, code: "èŠ±è“®" },
            { name: "å°æ±", lat: 22.7554, lng: 121.1440, code: "å°æ±" },
            { name: "å®œè˜­", lat: 24.7570, lng: 121.7530, code: "å®œè˜­" },
            { name: "æ¡ƒåœ’", lat: 24.9936, lng: 121.3010, code: "æ¡ƒåœ’" },
            { name: "æ–°åŒ—", lat: 25.0169, lng: 121.4628, code: "æ–°åŒ—" },
            { name: "è‹—æ —", lat: 24.5601, lng: 120.8214, code: "è‹—æ —" },
            { name: "å½°åŒ–", lat: 24.0800, lng: 120.5400, code: "å½°åŒ–" },
            { name: "å—æŠ•", lat: 23.9100, lng: 120.6800, code: "å—æŠ•" },
            { name: "é›²æ—", lat: 23.7000, lng: 120.4300, code: "é›²æ—" },
            { name: "å±æ±", lat: 22.6760, lng: 120.4900, code: "å±æ±" },
            { name: "æ¾æ¹–", lat: 23.5694, lng: 119.5800, code: "æ¾æ¹–" },
            { name: "é‡‘é–€", lat: 24.4500, lng: 118.3200, code: "é‡‘é–€" },
            { name: "é€£æ±Ÿ", lat: 26.1500, lng: 119.9500, code: "é€£æ±Ÿ" },
            { name: "ééƒ¨", lat: 25.1833, lng: 121.5333, code: "ééƒ¨" }
        ];

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            map = L.map('map').setView([23.5, 121], 7);
            
            // åŠ å…¥åœ°åœ–åœ–å±¤
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // è¼‰å…¥æ‰€æœ‰æ¸¬ç«™çš„å¤©æ°£è³‡æ–™
            loadAllStationsWeather();
        }

        // è¼‰å…¥æ‰€æœ‰æ¸¬ç«™çš„å¤©æ°£è³‡æ–™
        async function loadAllStationsWeather() {
            const apiKey = document.getElementById("apiKey").value.trim();
            if (!apiKey) {
                console.log('APIæˆæ¬Šç¢¼æœªè¨­å®šï¼Œç„¡æ³•è¼‰å…¥åœ°åœ–è³‡æ–™');
                return;
            }

            // æ¸…é™¤ç¾æœ‰çš„æ¨™è¨˜
            weatherMarkers.forEach(marker => map.removeLayer(marker));
            weatherMarkers = [];

            // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰æ¸¬ç«™è³‡æ–™
            const promises = taiwanStations.map(station => loadStationWeather(apiKey, station));
            await Promise.allSettled(promises);
        }

        // è¼‰å…¥å–®ä¸€æ¸¬ç«™å¤©æ°£è³‡æ–™
        async function loadStationWeather(apiKey, station) {
            try {
                const apiUrl = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=${apiKey}&locationName=${station.code}&format=JSON`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) return;
                
                const data = await response.json();
                if (!data.records || !data.records.Station || data.records.Station.length === 0) return;
                
                const stationData = data.records.Station[0];
                const weatherElements = stationData.WeatherElement;
                
                // æå–é—œéµè³‡æ–™
                const temp = parseFloat(weatherElements.AirTemperature) || 0;
                const weather = weatherElements.Weather || 'N/A';
                const humidity = weatherElements.RelativeHumidity || 'N/A';
                
                // æ ¹æ“šæº«åº¦æ±ºå®šåœ–æ¨™é¡è‰²
                let tempClass = 'temp-mild';
                if (temp >= 30) tempClass = 'temp-hot';
                else if (temp >= 25) tempClass = 'temp-warm';
                else if (temp >= 20) tempClass = 'temp-mild';
                else if (temp >= 15) tempClass = 'temp-cool';
                else tempClass = 'temp-cold';
                
                // å‰µå»ºè‡ªå®šç¾©åœ–æ¨™
                const customIcon = L.divIcon({
                    className: 'weather-icon ' + tempClass,
                    html: Math.round(temp) + 'Â°',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                // å‰µå»ºæ¨™è¨˜
                const marker = L.marker([station.lat, station.lng], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h6><strong>${station.name}</strong></h6>
                            <p><strong>æº«åº¦:</strong> ${temp.toFixed(1)}Â°C</p>
                            <p><strong>å¤©æ°£:</strong> ${weather}</p>
                            <p><strong>æº¼åº¦:</strong> ${humidity}%</p>
                            <button class="btn btn-sm btn-primary" onclick="queryStationWeather('${station.code}')">
                                æŸ¥çœ‹è©³ç´°è³‡æ–™
                            </button>
                        </div>
                    `);
                
                weatherMarkers.push(marker);
                
            } catch (error) {
                console.log(`è¼‰å…¥ ${station.name} è³‡æ–™å¤±æ•—:`, error);
            }
        }

        // æŸ¥è©¢ç‰¹å®šæ¸¬ç«™è©³ç´°è³‡æ–™
        function queryStationWeather(stationCode) {
            document.getElementById('location').value = stationCode;
            document.getElementById('weatherForm').dispatchEvent(new Event('submit'));
        }
        
        // åœ¨åœ°åœ–ä¸Šæ¨™ç¤ºç‰¹å®šåœ°é»
        function highlightLocationOnMap(locationName) {
            // æ¸…é™¤ç¾æœ‰çš„é«˜äº®æ¨™è¨˜
            if (window.highlightMarker) {
                map.removeLayer(window.highlightMarker);
            }
            
            // å°‹æ‰¾å°æ‡‰çš„æ¸¬ç«™è³‡æ–™
            const station = taiwanStations.find(s => s.name === locationName || s.code === locationName);
            if (station) {
                // å‰µå»ºé«˜äº®æ¨™è¨˜
                const highlightIcon = L.divIcon({
                    className: 'highlight-marker',
                    html: '<div style="background-color: #ff0000; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ğŸ“</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                // æ·»åŠ é«˜äº®æ¨™è¨˜åˆ°åœ°åœ–
                window.highlightMarker = L.marker([station.lat, station.lng], { icon: highlightIcon })
                    .addTo(map)
                    .bindPopup(`<strong>${station.name}</strong><br>å·²é¸å–æ­¤æ¸¬ç«™`);
                
                // å°‡åœ°åœ–è¦–åœ–ç§»å‹•åˆ°è©²ä½ç½®
                map.setView([station.lat, station.lng], 10);
            }
        }

        // CWA API ç›¸é—œå‡½æ•¸
        function getElementValue(elements, elementName) {
            // æª¢æŸ¥ elements æ˜¯å¦ç‚ºé™£åˆ—
            if (Array.isArray(elements)) {
                const element = elements.find(el => el.elementName === elementName);
                return element ? element.elementValue : 'N/A';
            }
            // å¦‚æœä¸æ˜¯é™£åˆ—ï¼Œç›´æ¥å¾ç‰©ä»¶ä¸­å–å€¼
            return elements && elements[elementName] ? elements[elementName] : 'N/A';
        }

        function formatValue(value, unit = '') {
            if (value === 'N/A' || value === null || value === undefined) {
                return 'N/A';
            }
            // è™•ç†ç‰¹æ®Šå€¼ï¼Œå¦‚-99è¡¨ç¤ºç„¡è³‡æ–™
            if (value === '-99' || value === -99) {
                return 'N/A';
            }
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                return 'N/A';
            }
            return numValue.toFixed(1) + unit;
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            const successAlert = document.getElementById('successAlert');
            
            errorMessage.textContent = message;
            errorAlert.classList.remove('d-none');
            successAlert.classList.add('d-none');
        }

        function showSuccess() {
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            
            errorAlert.classList.add('d-none');
            successAlert.classList.remove('d-none');
        }

        function hideAlerts() {
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            
            errorAlert.classList.add('d-none');
            successAlert.classList.add('d-none');
        }

        function setLoadingState(isLoading) {
            const queryBtn = document.getElementById('queryBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            if (isLoading) {
                queryBtn.disabled = true;
                loadingSpinner.classList.remove('d-none');
                btnText.textContent = 'æŸ¥è©¢ä¸­...';
            } else {
                queryBtn.disabled = false;
                loadingSpinner.classList.add('d-none');
                btnText.textContent = 'æŸ¥è©¢';
            }
        }

        function updateTable(weatherData) {
            const tableBody = document.getElementById('weatherTableBody');
            tableBody.innerHTML = '';

            const row = document.createElement('tr');
            
            // æª¢æŸ¥é¢¨é€Ÿæ˜¯å¦è¶…é5ç´šé¢¨ (9 m/s)
            const windSpeed = parseFloat(weatherData.é¢¨åŠ›.replace(/[^\d.-]/g, '')) || 0;
            const windGust = parseFloat(weatherData.é™£é¢¨.replace(/[^\d.-]/g, '')) || 0;
            const maxWindSpeed = Math.max(windSpeed, windGust);
            
            // é¢¨é€Ÿè­¦å‘Šæ¨£å¼
            const windSpeedClass = maxWindSpeed >= 9 ? 'wind-warning' : '';
            const windGustClass = windGust >= 9 ? 'wind-warning' : '';
            
            row.innerHTML = `
                <td>${weatherData.è§€æ¸¬æ™‚é–“}</td>
                <td>${weatherData.æº«åº¦}</td>
                <td>${weatherData.å¤©æ°£}</td>
                <td>${weatherData.é¢¨å‘}</td>
                <td class="${windSpeedClass}">${weatherData.é¢¨åŠ›}</td>
                <td class="${windGustClass}">${weatherData.é™£é¢¨}</td>
                <td>${weatherData.èƒ½è¦‹åº¦}</td>
                <td>${weatherData.ç›¸å°æº¼åº¦}</td>
                <td>${weatherData.æµ·å¹³é¢æ°£å£“}</td>
                <td>${weatherData.ç´¯ç©é›¨é‡}</td>
                <td>${weatherData.æ—¥ç…§æ™‚æ•¸}</td>
            `;
            tableBody.appendChild(row);
            
            // é¡¯ç¤ºæˆ–éš±è—é¢¨é€Ÿè­¦å‘Š
            const windAlert = document.getElementById('windAlert');
            if (maxWindSpeed >= 9) {
                windAlert.classList.remove('d-none');
            } else {
                windAlert.classList.add('d-none');
            }
        }

        // è¡¨å–®æäº¤äº‹ä»¶
        document.getElementById("weatherForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            
            const apiKey = document.getElementById("apiKey").value.trim();
            const location = document.getElementById("location").value;

            // é©—è­‰è¼¸å…¥
            if (!apiKey) {
                showError('è«‹è¼¸å…¥APIæˆæ¬Šç¢¼');
                return;
            }
            //CWA-BC818A75-95F0-4917-AE45-2459483BDCD9

            // éš±è—ä¹‹å‰çš„è¨Šæ¯
            hideAlerts();
            
            // è¨­å®šè¼‰å…¥ç‹€æ…‹
            setLoadingState(true);

            try {
                // æ§‹å»ºAPI URL
                const apiUrl = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=${apiKey}&locationName=${location}&format=JSON`;
                
                console.log('æ­£åœ¨è«‹æ±‚API:', apiUrl);
                
                // ç™¼é€APIè«‹æ±‚
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('APIå›æ‡‰:', data);
                
                // æª¢æŸ¥APIå›æ‡‰
                if (!data.records || !data.records.Station || data.records.Station.length === 0) {
                    throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šæ¸¬ç«™çš„è³‡æ–™');
                }
                
                const locationData = data.records.Station[0];
                const weatherElements = locationData.WeatherElement;
                const observationTime = locationData.ObsTime.DateTime;
                
                // æå–æ°£è±¡è³‡æ–™ - æ ¹æ“šå¯¦éš›APIçµæ§‹
                const weatherData = {
                    'è§€æ¸¬æ™‚é–“': observationTime,
                    'æº«åº¦': formatValue(weatherElements.AirTemperature, 'Â°C'),
                    'å¤©æ°£': weatherElements.Weather || 'N/A',
                    'é¢¨å‘': formatValue(weatherElements.WindDirection, 'åº¦'),
                    'é¢¨åŠ›': formatValue(weatherElements.WindSpeed, 'm/s'),
                    'é™£é¢¨': formatValue(weatherElements.GustInfo?.PeakGustSpeed, 'm/s'),
                    'èƒ½è¦‹åº¦': weatherElements.VisibilityDescription || 'N/A',
                    'ç›¸å°æº¼åº¦': formatValue(weatherElements.RelativeHumidity, '%'),
                    'æµ·å¹³é¢æ°£å£“': formatValue(weatherElements.AirPressure, 'ç™¾å¸•'),
                    'ç´¯ç©é›¨é‡': formatValue(weatherElements.Now?.Precipitation, 'æ¯«ç±³'),
                    'æ—¥ç…§æ™‚æ•¸': formatValue(weatherElements.SunshineDuration, 'å°æ™‚')
                };
                
                console.log('è™•ç†å¾Œçš„æ°£è±¡è³‡æ–™:', weatherData);
                
                // æ›´æ–°è¡¨æ ¼
                updateTable(weatherData);
                showSuccess();
                
                // åœ¨åœ°åœ–ä¸Šæ¨™ç¤ºé¸å–çš„åœ°é»
                highlightLocationOnMap(location);
                
            } catch (error) {
                console.error('APIè«‹æ±‚éŒ¯èª¤:', error);
                showError(`ç„¡æ³•ç²å–æ°£è±¡è³‡æ–™: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        });

        // é™¤éŒ¯å‡½æ•¸
        async function debugAPI() {
            const apiKey = document.getElementById("apiKey").value.trim();
            const location = document.getElementById("location").value;

            if (!apiKey) {
                alert('è«‹è¼¸å…¥APIæˆæ¬Šç¢¼');
                return;
            }
            
            try {
                const apiUrl = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=${apiKey}&locationName=${location}&format=JSON`;
                console.log('=== é™¤éŒ¯æ¨¡å¼ ===');
                console.log('API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('HTTPç‹€æ…‹:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('=== å®Œæ•´APIå›æ‡‰ ===');
                console.log(JSON.stringify(data, null, 2));
                
                if (data.records && data.records.Station) {
                    console.log('=== æ¸¬ç«™æ•¸é‡ ===', data.records.Station.length);
                    data.records.Station.forEach((station, index) => {
                        console.log(`=== æ¸¬ç«™ ${index} ===`);
                        console.log('æ¸¬ç«™åç¨±:', station.StationName);
                        console.log('è§€æ¸¬æ™‚é–“:', station.ObsTime);
                        console.log('æ°£è±¡å…ƒç´ :', station.WeatherElement);
                    });
                } else {
                    console.log('APIå›æ‡‰ä¸­æ²’æœ‰æ‰¾åˆ°æ¸¬ç«™è³‡æ–™');
                }
                
                alert('é™¤éŒ¯è³‡è¨Šå·²è¼¸å‡ºåˆ°æ§åˆ¶å°ï¼Œè«‹æŒ‰F12æŸ¥çœ‹');
                
            } catch (error) {
                console.error('é™¤éŒ¯APIè«‹æ±‚éŒ¯èª¤:', error);
                alert('é™¤éŒ¯å¤±æ•—: ' + error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚è¨­å®šé è¨­æ™‚é–“å’Œåˆå§‹åŒ–åœ°åœ–
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('dateTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            // åˆå§‹åŒ–åœ°åœ–
            initMap();
            
            // ç›£è½åœ°é»è¼¸å…¥æ¡†è®ŠåŒ–
            document.getElementById('location').addEventListener('input', function() {
                const locationValue = this.value.trim();
                if (locationValue) {
                    highlightLocationOnMap(locationValue);
                }
            });
        });
    </script>
    
    <!-- ç‰ˆæ¬Šè³‡è¨Š -->
    <div id="credit" onclick="alert('è¨­è¨ˆè€…ï¼šErica\nç‰ˆæœ¬ï¼šv1.0\næ—¥æœŸï¼š2025-10-25');">
        Â© 2025 Erica
    </div>
</body>
</html>